# Требования (FR/NFR) — Crypto Portfolio

## Функциональные — MVP
1. **Сделки (CRUD):** тип (`buy/sell/exchange_in/exchange_out/deposit/withdrawal`), монета (UPPER), объём, цена, дата/время (UTC), стратегия (`long/mid/short/scalp`), источник, заметки.
2. **Позиции FIFO:** агрегировать по (монета, стратегия); считать среднюю цену, стоимость, реализ./нереализ. PnL.
3. **Цены:** CoinGecko *Simple Price*; кэш 60с; при ошибке — показывать 0/последнее.
4. **Фильтры:** по монете и стратегии (влияют на позиции и сделки).
5. **Экспорт CSV:** сделки и позиции.
6. **Бэкап БД:** копия SQLite-файла в `data/backups`.
7. **Офлайн-режим:** без сети UI доступен, сделки сохраняются.

## Функциональные — Итерация 1
8. **Алерты:** правила (price / unreal_abs / unreal_pct), cooldown, история.
9. **Аналитика:** мини-графики 7/30д (стоимость, PnL), локальный кэш истор. цен, круговая доля монет.
10. **Импорт CSV:** маппинг колонок, предпросмотр, нормализация чисел (точки/запятые), batch-вставка.
11. **Saved Views:** сохранение/выбор пресетов фильтров/колонок.

## Функциональные — Итерация 2
12. **Мультипортфели:** таблица `Portfolio`, селектор активного портфеля, миграция текущих записей → `default`.
13. **Capital Management:** «лестница закупок» + простые индикаторы (страх/жадность) для подсказок.

## Функциональные — Итерация 3
14. **Decimal-точность:** переход на Decimal, форматтер чисел.
15. **Снапшоты дня:** дневные слепки стоимости/PNL.
16. **Backup/Restore zip** и (опционально) **portable .exe** (PyInstaller).
17. **Тесты (pytest):** FIFO/PNL и адаптер цен (моки).

## Бизнес-правила
- **FIFO:** приход добавляет лоты; расход списывает из очереди. Реализованный PnL = `qty * (sell_price - lot_price)`.
- **Средняя цена:** `avg_cost = cost_basis / qty`.
- **Нереализованный PnL:** `(current_price * qty) - cost_basis`; `% = (current_price - avg_cost) / avg_cost * 100`.
- **Единицы:** тикеры — UPPER; время — UTC в БД, локально отображаем строкой.
- **Цены:** TTL 60с; таймаут запроса 8с; ошибки не ломают UI.

## Нефункциональные
- **Платформа:** Windows 11, Python 3.13 (возможен 3.11–3.12).
- **Приватность:** данные только локально, без внешних аккаунтов.
- **Производительность:** индексы на (coin, strategy) и ts_utc; кэш цен.
- **UX:** SPA-интерфейс с вкладками; `autocomplete=off` в формах; понятные ошибки/уведомления.
- **Локализация:** RU (базовая), EN (позже).
